Title
========================================================

Chapter 3.

Regression

```{r, cache=T}
library(DLMBook)
f <- file.path(getwd(),"../inst/extdata/P.dat")
capm_1(f)
```

デンマークとスペインの年間投資額
SUTSE

それぞれは線形成長モデル
$$Y_t = \mu_t + v_t $$
$$\mu_t = \mu_{t-1} + \beta_{t} + w_{\mu , t} $$ 
$$\beta_t = \beta_{t-1} + w_{\beta , t} $$

1期先予測と実現値を同時刻で比較するなら,tにおける1期先予測の値を
t+1での実現と比較すればよい.

デンマークかスペインかどちらか分からないが、
1番目のデータのほうが本モデルで説明できていそうである。
信頼区間に入る割合から。
但し,0.9くらい大きくするとずれが大きくなる。

```{r}
library(DLMBook)
mod <- dlmModPoly(order=2)
mod$FF <- mod$FF %x% diag(2)
mod$GG <- mod$GG %x% diag(2)
W1 <- matrix(0,2,2)
W2 <- diag(c(49,437266))
W2[1,2] <- W2[2,1] <- 155
mod$W <- bdiag(W1, W2)
V <- diag(c(72,14353))
V[1,2] <- V[2,1] <- 1018
mod$V <- V
mod$m0 <- rep(0,4)
mod$C0 <- diag(4) * 1e7

invest <- ts(read.table("../inst//extdata/invest2.dat",skip=0
                        , colClasses="numeric")[,]
             , start=1960)
investFilt <- dlmFilter(y=invest, mod)
conf.interval <- 0.3
dt1 <- DLMFilteredPredictionToDF(
  dlmFiltered=investFilt,exclude.indices=c(1:2), columnIndex=1
  , conf.interval=conf.interval)
dt2 <- DLMFilteredPredictionToDF(
  dlmFiltered=investFilt,exclude.indices=c(1), columnIndex=2
  , conf.interval=conf.interval)
print(conf.interval)
dfs <- list(dt1, dt2)
lapply(X=c(1:2), FUN=function(i){
  g <- ggplot(data=dfs[[i]]$dt,aes(x=t, y=value, colour=colour, group=variable))
  g <- g + geom_point() + geom_line()
  print(g)
  tdt <- dfs[[i]]$TSDT
  predictionHitRate <- CountInsideValuesRatio(
    values=tdt$original, upper=tdt$upr, lower=tdt$lwr)
  print(predictionHitRate)
  NULL
  })
```{r}
